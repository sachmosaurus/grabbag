<! Greenland-1200 style="color-scheme: light;">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bucketlists</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #fbfbfa; --border: #e9e9e8; --text: #37352f; --accent: #2383e2; --card: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 20px; }
        .auth-box, .app-box { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        input, select, textarea { width: 100%; padding: 8px; margin: 8px 0; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        button.secondary { background: #f1f1f0; color: var(--text); }
        .bucket-item { border: 1px solid var(--border); padding: 12px; border-radius: 6px; margin-bottom: 10px; position: relative; }
        .tag { font-size: 0.75rem; background: #efefef; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        .hidden { display: none; }
        .nav-tabs { margin-bottom: 20px; }
        .nav-tabs button { margin-right: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ü™£ Bucketlists</h1>
        <div id="userStatus">Not signed in</div>
    </header>

    <div id="authSection" class="auth-box">
        <h3>Sign In / Up</h3>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signIn()">Sign In</button>
        <button class="secondary" onclick="signUp()">Sign Up</button>
    </div>

    <div id="appSection" class="hidden">
        <div class="nav-tabs">
            <button onclick="showTab('myBucket')">My Big Bucket</button>
            <button class="secondary" onclick="showTab('explore')">Explore Others</button>
            <button class="secondary" onclick="showTab('logs')">Grab Logs</button>
            <button class="secondary" onclick="signOut()">Log Out</button>
        </div>

        <div id="tab-myBucket" class="app-box">
            <h3>Add to Big Bucket</h3>
            <div class="grid">
                <input id="smallBucket" placeholder="Small Bucket (e.g. Science)">
                <input id="tinyBucket" placeholder="Tiny Bucket (e.g. Geology)">
            </div>
            <input id="itemTitle" placeholder="Item Title">
            <input id="itemUrl" placeholder="URL (optional)">
            <textarea id="itemNotes" placeholder="Notes..."></textarea>
            <button onclick="addItem()">Add to List</button>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
            <h3>Your Items</h3>
            <div id="myItemsList"></div>
        </div>

        <div id="tab-explore" class="app-box hidden">
            <h3>Explore Users</h3>
            <input type="text" id="partnerSearch" placeholder="Search by email..." oninput="loadOthers()">
            <div id="otherItemsList"></div>
        </div>

        <div id="tab-logs" class="app-box hidden">
            <h3>Who grabbed from you?</h3>
            <div id="logStatus"></div>
            <div id="logList"></div>
            <button onclick="emailLogs()">üìß Draft Log Email</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://qjkhmmlpjqiugahbxkia.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqa2htbWxwanFpdWdhaGJ4a2lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzcwMjMsImV4cCI6MjA4NzY1MzAyM30.igxd3POf-D9kkoLWLVW7VJ315aQhzXDLsMtISlOFegU";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let user = null;

    // --- AUTH ---
    async function checkUser() {
        const { data } = await sb.auth.getUser();
        user = data?.user;
        if (user) {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('userStatus').innerText = `Hello, ${user.email}`;
            loadMyItems();
        }
    }

    async function signUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await sb.auth.signUp({ email, password });
        if (error) alert(error.message); else alert("Check your email!");
    }

    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) alert(error.message); else location.reload();
    }

    async function signOut() {
        await sb.auth.signOut();
        location.reload();
    }

    // --- LOGIC ---
    function showTab(tabId) {
        ['myBucket', 'explore', 'logs'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
        document.getElementById(`tab-${tabId}`).classList.remove('hidden');
        if (tabId === 'explore') loadOthers();
        if (tabId === 'logs') loadLogs();
    }

    async function addItem() {
        const payload = {
            owner_id: user.id,
            owner_email: user.email,
            small_bucket: document.getElementById('smallBucket').value,
            tiny_bucket: document.getElementById('tinyBucket').value,
            title: document.getElementById('itemTitle').value,
            url: document.getElementById('itemUrl').value,
            notes: document.getElementById('itemNotes').value
        };
        const { error } = await sb.from('items').insert([payload]);
        if (error) alert(error.message); else loadMyItems();
    }

    async function loadMyItems() {
        const { data } = await sb.from('items').select('*').eq('owner_id', user.id);
        renderItems(data, 'myItemsList', true);
    }

    async function loadOthers() {
        const search = document.getElementById('partnerSearch').value;
        let query = sb.from('items').select('*').neq('owner_id', user.id);
        if (search) query = query.ilike('owner_email', `%${search}%`);
        
        const { data } = await query;
        renderItems(data, 'otherItemsList', false);
    }

    function renderItems(items, targetId, isOwner) {
        const container = document.getElementById(targetId);
        container.innerHTML = items?.map(i => `
            <div class="bucket-item">
                <span class="tag">${i.small_bucket}</span> <span class="tag">${i.tiny_bucket}</span>
                <strong>${i.title}</strong>
                ${i.url ? `<br><a href="${i.url}" target="_blank">${i.url}</a>` : ''}
                <p style="font-size: 0.9rem; color: #666;">${i.notes || ''}</p>
                ${!isOwner ? `<button onclick="grabItem('${i.id}')" style="font-size: 0.7rem;">üêæ Grab</button>` : `<button onclick="deleteItem('${i.id}')" style="font-size: 0.7rem; background: #ff4d4d;">Delete</button>`}
                <div style="font-size: 0.7rem; color: #999; margin-top: 5px;">User: ${i.owner_email}</div>
            </div>
        `).join('') || 'No items found.';
    }

    async function grabItem(id) {
        const { data: item } = await sb.from('items').select('*').eq('id', id).single();
        // 1. Copy to my bucket
        await sb.from('items').insert([{
            ...item, id: undefined, created_at: undefined, owner_id: user.id, owner_email: user.email
        }]);
        // 2. Log it for the owner
        await sb.from('grab_logs').insert([{
            grabber_name: user.email,
            owner_id: item.owner_id,
            item_title: item.title
        }]);
        alert("Grabbed! Check your Big Bucket.");
    }

    async function deleteItem(id) {
        await sb.from('items').delete().eq('id', id);
        loadMyItems();
    }

    async function loadLogs() {
        const { data } = await sb.from('grab_logs').select('*').eq('owner_id', user.id).eq('notified', false);
        const list = document.getElementById('logList');
        document.getElementById('logStatus').innerText = `${data?.length || 0} new grabs since last email.`;
        list.innerHTML = data?.map(l => `
            <div style="font-size: 0.85rem; padding: 5px; border-bottom: 1px solid #eee;">
                ${new Date(l.created_at).toLocaleDateString()}: <b>${l.grabber_name}</b> grabbed "${l.item_title}"
            </div>
        `).join('') || '';
    }

    function emailLogs() {
        const list = Array.from(document.getElementById('logList').children).map(div => div.innerText).join('%0D%0A');
        const mailto = `mailto:${user.email}?subject=Bucketlist Grab Report&body=Here are the latest grabs from your list:%0D%0A%0D%0A${list}`;
        window.location.href = mailto;
        // Optionally mark as notified in Supabase here
    }

    checkUser();
</script>
</body>
</html>
